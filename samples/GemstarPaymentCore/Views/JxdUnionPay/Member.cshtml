@model JxdUnionPayMemberViewModel  
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>确认支付</title>
    <meta name="viewport" content="width=device-width">
    <meta name="Keywords" content="">
    <meta name="Description" content="">
    <meta name="viewport" content="initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=yes">
    <link rel="stylesheet" href="~/css/reset.css">
    <link rel="stylesheet" href="~/css/jxdUnionPay.css">
</head>
<body class="bj">
    @using (Html.BeginForm())
    {
        <div class="content">
            <div class="pay-header">
                <div class="pay-order">
                    我的订单
                </div>
                <div class="pay-project">
                    <div class="project-name"><span>支付项目：</span><p>@Model.OrderTitle</p></div>
                    <em class="project-price"><span>￥</span>@Model.PayFee</em>
                </div>
            </div>
        </div>
        <div class="content">
            <div class="pay-content">
                <div class="pay-mode-title">
                    我的优惠券
                </div>
                <div class="pay-mode">
                    <div class="pay-code">
                        <div class="pay-left" id="memberTicketSelect">
                            <div class="pay-img">
                                <img src="~/images/ticket.png" alt="">
                            </div>
                            <span class="code-name">@(Model.UsedTicket ? "已使用优惠券":"")</span>
                            <p class="code-num">@(Model.UsedTicket ? Model.TicketNo:"")</p>
                            <em class="code-price">@(Model.UsedTicket ? Model.TicketAmount.ToString():"")</em>
                            <b class="bottom"></b>
                            <input type="hidden" value="@(Model.TicketNo)" id="ticketId" />
                            <input type="hidden" value="" id="ticketProfileId" />
                            <input type="hidden" value="@(Model.TicketAmount)" id="ticketAmount" />
                            <input type="hidden" value="@(Model.UsedTicket ? "1":"0")" id="usedTicket" />

                            <div class="code-more" style="display: none;">
                                @if (Model.UsedTicket)
                                {
                                    <div class="ticket-code-list" data-ticket-id="@Model.TicketNo" data-ticket-profileid="@Model.TicketNo" data-ticket-amount="@Model.TicketAmount" onclick="selectMemberTicket(this)">
                                        <div class="pay-img">
                                            <img src="../images/ticket.png" alt="">
                                        </div>
                                        <span>已使用优惠券</span>
                                        <p>@Model.TicketNo</p>
                                        <em>￥@Model.TicketAmount</em>
                                    </div>
                                }
                            </div>
                        </div>
                        <input type="radio" name="payUseTicket" id="memberTicket" @(Model.UsedTicket ? "checked='checked'" : "style=display:none") >
                    </div>
                    @if (!Model.UsedTicket)
                    {
                    <label class="pay-code">
                        <div class="pay-left">
                            <div class="pay-img">
                                <img src="~/images/notuseticket.png" alt="">
                            </div>
                            <span>不使用优惠券</span>
                        </div>
                        <input type="radio" name="payUseTicket" @(Model.UsedTicket ? "" : "checked='checked'")>
                    </label>
                    }
                </div>
            </div>
        </div>
        <div class="content">
            <div class="pay-content">
                <div class="pay-mode-title">
                    支付方式
                </div>
                <div class="pay-mode">
                    <div class="pay-code">
                        <div class="pay-left" id="memberCardSelect">
                            <div class="pay-img">
                                <img src="~/images/code.png" alt="">
                            </div>
                            @Html.HiddenFor(m => m.MemberId)
                            @Html.Hidden("memberCardNo", Model.MemberInfos[0].CardNo)
                            <input type="hidden" id="memberHavePassword" value="@Model.MemberInfos[0].HavePassword" />
                            <span class="code-name">@Model.MemberInfos[0].CardTypeName</span>
                            <p class="code-num">@Model.MemberInfos[0].CardNoDisplay</p>
                            <em class="code-price">￥@Model.MemberInfos[0].Balance</em>
                            <b class="bottom"></b>

                            <div class="code-more" style="display: none;">
                                @foreach (var memberInfo in Model.MemberInfos)
                                {
                                    <div class="code-list" data-member-id="@memberInfo.Id" data-member-cardno="@memberInfo.CardNo" data-member-password="@memberInfo.HavePassword">
                                        <div class="pay-img">
                                            <img src="~/images/code.png" alt="">
                                        </div>
                                        <span>@memberInfo.CardTypeName</span>
                                        <p>@memberInfo.CardNoDisplay</p>
                                        <em>￥@memberInfo.Balance</em>
                                    </div>
                                }
                            </div>
                        </div>
                        <input type="radio" name="payMode" id="member" style="display:none;">
                    </div>
                    <label class="pay-code">
                        <div class="pay-left">
                            <div class="pay-img">
                                <img src="~/images/wx.png" alt="">
                            </div>
                            <span>微信</span>
                        </div>
                        <input type="radio" name="payMode" checked="checked">
                    </label>
                </div>
            </div>
        </div>
        <div class="shade" style="display: none;">
            <div class="password">
                <p>请输入密码：</p>
                @Html.PasswordFor(w => w.CardPassword)
                <div class="password-btn">
                    <div class="cancel">返回</div>
                    <input type="submit" value="确定" id="submitCardPassword">
                </div>
            </div>
        </div>
        <div class="pay-btn">
            <input type="hidden" value="@Model.WxPayUrl" id="wxPayUrl" />
            <input type="submit" value="确定" id="submit">
        </div>
    }
    <script src="~/lib/jquery/dist/jquery.js"></script>
    <script type="text/javascript" src="~/js/public.js"></script>
    <script>
        var payId = "@Model.OrderId";
        var memberAllId = "@Model.MemberAllIds";

        function selectMemberTicket(obj) {
            var $this = $(obj);
            var codeName = $this.find('span').text();
            var codeNum = $this.find('p').text();
            var codePrice = $this.find('em').text();
            var memberId = $this.data("ticket-profileid");
            var ticketNo = $this.data("ticket-id");
            var ticketAmount = $this.data("ticket-amount");
            var $payCode = $this.parents(".pay-code");
            $payCode.find('.code-name').text(codeName);
            $payCode.find('.code-num').text(codeNum);
            $payCode.find('.code-price').text(codePrice);
            $payCode.find('#ticketId').val(ticketNo);
            $payCode.find('#ticketProfileId').val(memberId);
            $payCode.find("#ticketAmount").val(ticketAmount);
            $payCode.find("#memberTicket").prop("checked", "checked");
            showOrHideTicketSelect();
        }
        function selectMemberCard(obj) {
            var $this = $(obj);
            var codeName = $this.find('span').text();
            var codeNum = $this.find('p').text();
            var codePrice = $this.find('em').text();
            var memberId = $this.data("member-id");
            var cardNo = $this.data("member-cardno");
            var havePassword = $this.data("member-password");
            var $payCode = $this.parents(".pay-code");
            $payCode.find('.code-name').text(codeName);
            $payCode.find('.code-num').text(codeNum);
            $payCode.find('.code-price').text(codePrice);
            $payCode.find('#memberCardNo').val(cardNo);
            $payCode.find('#MemberId').val(memberId);
            $payCode.find("#memberHavePassword").val(havePassword);
            $payCode.find("#member").prop("checked", "checked");
            showOrHideMbrcardSelect();
        }
        function doPay() {
            var profileId = $('#ticketProfileId').val();
            var ticketId = $('#ticketId').val();
            var ticketAmount = $("#ticketAmount").val();
            var usedTicket = $("#usedTicket").val();
            if ($('#memberTicket').is(':checked') && ticketId && profileId && usedTicket == "0") {
                $("#submit").attr("disabled", "disabled");
                $.post("@Url.Action("UseMemberTicket")", { id: "@Model.OrderId", profileId: profileId, ticketId: ticketId, ticketAmount: ticketAmount }, function (data) {
                    $("#submit").removeAttr("disabled");
                    if (data.success) {
                        alert(data.data.msg);
                        $("#usedTicket").val("1");
                        if (data.data.needPay) {
                            $("#wxPayUrl").val(data.data.needPayUrl);
                            doPayAfterTicket();
                        } else {
                            //直接使用优惠券已经支付成功，转到支付成功页面
                            location.href = "@Url.Action("Index")" +"?type=lcsw&id="+"@Model.OrderId";
                        }
                    } else {
                        alert(data.data);
                        doPayAfterTicket();
                    }
                }, "json");
            } else {
                doPayAfterTicket();
            }
        }
        function doPayAfterTicket() {
            if ($('#member').is(':checked')) {
                $('#CardPassword').val('');
                //根据是否有密码来决定是否弹出输入密码框
                var havePassword = $('#memberHavePassword').val();
                if (havePassword == "1") {
                    $('.code-more:visible').slideToggle();
                    $('.shade').show();
                    $('#CardPassword').focus();
                    return false;
                } else {
                    doMemberPay();
                }
            } else {
                var wxPayUrl = $("#wxPayUrl").val();
                location.href = wxPayUrl;
            }
        }
        function doMemberPay() {
            var cardPassword = $("#CardPassword").val();
            var havePassword = $("#memberHavePassword").val();
            if (!cardPassword && havePassword == "1") {
                alert("请输入支付密码");
                return;
            }
            var MemberId = $("#MemberId").val();
            if (!MemberId) {
                alert("请先选择会员卡");
                return;
            }
            var cardNo = $('#memberCardNo').val();
            $('#submitCardPassword').attr("disabled", "disabled");
            $.post("@Url.Action("MemberPay")", { cardPassword: cardPassword, memberId:MemberId, orderId: "@Model.OrderId",cardNo:cardNo }, function (data) {
                if (data.success) {
                    $('.shade').hide();
                    if (data.data) {
                        location.href = data.data;
                    }
                } else {
                    alert(data.data);
                    $('#submitCardPassword').removeAttr("disabled");
                }
            }, "json");
        }
        function showTicketMsg(msg) {
            $("#memberTicketSelect").find(".code-name").text(msg);
        }
        function hideLetters(msg) {
            if (msg.length > 4) {
                return "****" + msg.substr(msg.length - 4, 4);
            }
            return msg;
        }
        function loadMemberTicket() {
            if (payId && memberAllId) {
                var $memberTicketSelect = $("#memberTicketSelect");
                $memberTicketSelect.find(".code-more").empty();
                showTicketMsg("正在加载中...");
                $.post("@Url.Action("QueryMemberTicket")", { id: payId, profileIds: memberAllId }, function (data) {
                    if (data.success) {
                        var tickets = data.data;
                        var firstTicket = tickets[0];
                        $memberTicketSelect.find(".code-name").text(firstTicket.ticketTypeCname);
                        $memberTicketSelect.find(".code-num").text(hideLetters(firstTicket.ticketCode));
                        $memberTicketSelect.find(".code-price").text(firstTicket.amount);
                        $("#ticketId").val(firstTicket.ticketCode);
                        $('#ticketProfileId').val(firstTicket.id);
                        $("#ticketAmount").val(firstTicket.amount);

                        $.each(tickets, function (index, ticket) {
                            var html = '<div class="ticket-code-list" data-ticket-id="' + ticket.ticketCode + '" data-ticket-profileid="' + ticket.id + '" data-ticket-amount="' + ticket.amount +'" onclick="selectMemberTicket(this)">';
                            html += '<div class="pay-img">';
                            html += '<img src="../images/ticket.png" alt="">';
                            html += '</div>';
                            html += '<span>' + ticket.ticketTypeCname + '</span>';
                            html += '<p>' + hideLetters(ticket.ticketCode) + '</p>';
                            html += '<em>￥' + ticket.amount+'</em>';
                            html += '</div>';
                            $(html).appendTo($memberTicketSelect.find(".code-more"));
                        });
                    } else {
                        showTicketMsg(data.data);
                    }
                }, "json");
            }
        }
        //控制只能通过选择优惠券才能选择，不能直接点击
        function showOrHideTicketSelect() {
            if ($('#memberTicket').is(':checked')) {
                $('#memberTicket').show();
            } else {
                $('#memberTicket').hide();
            }
        }
        //控制只能通过选择会员卡才能选择，不能直接点击
        function showOrHideMbrcardSelect() {
            if ($('#member').is(':checked')) {
                $('#member').show();
            } else {
                $('#member').hide();
            }
        }
        $(function () {
            $('#memberCardSelect,#memberTicketSelect').click(function (e) {
                e.preventDefault();
                $(this).find('.code-more').slideToggle();
            });
            $('.ticket-code-list').click(function (e) {
                e.preventDefault();
                selectMemberTicket(this);
            });
            $('.code-list').click(function (e) {
                e.preventDefault();
                selectMemberCard(this);
            });
            $('#submit').click(function (e) {
                e.preventDefault();
                doPay();
            });
            $('#submitCardPassword').click(function (e) {
                e.preventDefault();
                doMemberPay();
            });
            $('.cancel').click(function () {
                $('.shade').hide();
            });
            $("input[name='payMode']").change(function (e) {
                showOrHideMbrcardSelect();
            });
            $("input[name='payUseTicket']").change(function (e) {
                showOrHideTicketSelect();
            });
            @if (!Model.UsedTicket)
                {
                    <text>loadMemberTicket();</text>
                }
            });
    </script>
</body>
</html>